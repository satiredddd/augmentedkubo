<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kubo PH AR</title>
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
    }

    body { 
      margin: 0; 
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }

    #start-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
      padding: 30px;
    }

    #start-screen.hidden {
      display: none;
    }

    #start-screen h1 {
      font-size: 36px;
      margin: 0 0 15px 0;
      text-align: center;
      font-weight: 700;
    }

    #start-screen p {
      font-size: 16px;
      margin: 0 0 40px 0;
      text-align: center;
      opacity: 0.95;
      max-width: 400px;
      line-height: 1.5;
    }

    #start-ar-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 20px 60px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #start-ar-btn:active {
      transform: scale(0.95);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    #start-ar-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error-message {
      background: rgba(244, 67, 54, 0.95);
      padding: 18px 25px;
      border-radius: 12px;
      margin-top: 25px;
      max-width: 90%;
      text-align: center;
      display: none;
      font-size: 14px;
      line-height: 1.6;
    }

    .error-message.visible {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .info-box {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 15px 25px;
      border-radius: 12px;
      margin-top: 25px;
      max-width: 90%;
      text-align: left;
      font-size: 13px;
      line-height: 1.8;
    }

    .info-box strong {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }

    #ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    #status-bar {
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(76, 175, 80, 0.95);
      backdrop-filter: blur(10px);
      padding: 18px 25px;
      border-radius: 16px;
      color: white;
      font-size: 15px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      transition: all 0.3s ease;
      display: none;
      text-align: center;
    }

    #status-bar.visible {
      display: block;
    }

    #place-button {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 20px 50px;
      border-radius: 50px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
      pointer-events: all;
      transition: all 0.3s ease;
      display: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #place-button.visible {
      display: block;
    }

    #place-button:active {
      transform: translateX(-50%) scale(0.95);
    }

    #controls-hint {
      position: fixed;
      bottom: 130px;
      left: 20px;
      right: 20px;
      background: rgba(76, 175, 80, 0.95);
      backdrop-filter: blur(10px);
      padding: 18px;
      border-radius: 14px;
      color: white;
      text-align: center;
      font-size: 14px;
      line-height: 1.7;
      display: none;
      pointer-events: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }

    #controls-hint.visible {
      display: block;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #crosshair {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      display: none;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1;
      }
    }

    #crosshair.visible {
      display: block;
    }

    #crosshair::before,
    #crosshair::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
    }

    #crosshair::before {
      top: 50%;
      left: 12px;
      right: 12px;
      height: 4px;
      transform: translateY(-50%);
    }

    #crosshair::after {
      left: 50%;
      top: 12px;
      bottom: 12px;
      width: 4px;
      transform: translateX(-50%);
    }

    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      color: white;
      flex-direction: column;
      gap: 20px;
    }

    #loading-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div id="start-screen">
    <h1>ü™ë AR Furniture</h1>
    <p>Place and interact with 3D furniture in your space. Works on almost any device with a camera!</p>
    <button id="start-ar-btn">üöÄ Start AR</button>
    <div id="error-msg" class="error-message"></div>
    <div class="info-box">
      <strong>‚úÖ Universal Compatibility:</strong>
      Works on Android 5+, iOS 11+, and most modern browsers. No special AR hardware required!
    </div>
  </div>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div>Initializing camera...</div>
  </div>

  <div id="ui-overlay">
    <div id="status-bar">
      <span id="status-text">‚ú® AR Active! Move your device to look around</span>
    </div>

    <div id="crosshair"></div>

    <button id="place-button">üìç Place Chair</button>

    <div id="controls-hint">
      ‚ú® Chair placed successfully!<br>
      ü§è Pinch to scale ‚Ä¢ üîÑ Drag to rotate ‚Ä¢ üëÜ Tap button to move
    </div>
  </div>

  <a-scene
    id="scene"
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true;"
    gesture-detector>

    <a-camera
      id="camera"
      gps-camera
      rotation-reader
      look-controls="enabled: false">
    </a-camera>

    <a-entity 
      id="furniture"
      visible="false"
      gesture-handler="minScale: 0.3; maxScale: 3; rotationFactor: 4">
      
      <!-- Chair seat -->
      <a-box 
        position="0 0.5 0" 
        width="0.5" 
        height="0.1" 
        depth="0.5"
        color="#8B4513"
        shadow="cast: true; receive: false"
        material="roughness: 0.7; metalness: 0.1">
      </a-box>
      
      <!-- Chair back -->
      <a-box 
        position="0 0.8 -0.2" 
        width="0.5" 
        height="0.5" 
        depth="0.1"
        color="#8B4513"
        shadow="cast: true; receive: false"
        material="roughness: 0.7; metalness: 0.1">
      </a-box>
      
      <!-- Chair legs -->
      <a-cylinder 
        position="-0.2 0.25 -0.2" 
        radius="0.03" 
        height="0.5" 
        color="#654321"
        material="roughness: 0.8; metalness: 0.2">
      </a-cylinder>
      <a-cylinder 
        position="0.2 0.25 -0.2" 
        radius="0.03" 
        height="0.5" 
        color="#654321"
        material="roughness: 0.8; metalness: 0.2">
      </a-cylinder>
      <a-cylinder 
        position="-0.2 0.25 0.2" 
        radius="0.03" 
        height="0.5" 
        color="#654321"
        material="roughness: 0.8; metalness: 0.2">
      </a-cylinder>
      <a-cylinder 
        position="0.2 0.25 0.2" 
        radius="0.03" 
        height="0.5" 
        color="#654321"
        material="roughness: 0.8; metalness: 0.2">
      </a-cylinder>

      <!-- Shadow circle -->
      <a-circle 
        position="0 0.01 0" 
        radius="0.35" 
        rotation="-90 0 0" 
        color="#000000" 
        opacity="0.4"
        material="shader: flat">
      </a-circle>

      <!-- Placement indicator ring -->
      <a-ring
        id="placement-ring"
        position="0 0.02 0"
        radius-inner="0.4"
        radius-outer="0.45"
        color="#4CAF50"
        rotation="-90 0 0"
        opacity="0.7"
        animation="property: rotation; to: -90 360 0; loop: true; dur: 3000; easing: linear">
      </a-ring>

    </a-entity>

    <a-entity light="type: ambient; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.6; castShadow: true" position="2 4 1"></a-entity>

  </a-scene>

  <script>
    // Gesture detector component
    AFRAME.registerComponent('gesture-detector', {
      schema: {
        element: { default: '' }
      },

      init: function () {
        this.targetElement = this.data.element && document.querySelector(this.data.element);
        if (!this.targetElement) {
          this.targetElement = this.el;
        }

        this.internalState = {
          previousState: null
        };

        this.emitGestureEvent = this.emitGestureEvent.bind(this);

        this.targetElement.addEventListener('touchstart', this.emitGestureEvent);
        this.targetElement.addEventListener('touchend', this.emitGestureEvent);
        this.targetElement.addEventListener('touchmove', this.emitGestureEvent);
      },

      remove: function () {
        this.targetElement.removeEventListener('touchstart', this.emitGestureEvent);
        this.targetElement.removeEventListener('touchend', this.emitGestureEvent);
        this.targetElement.removeEventListener('touchmove', this.emitGestureEvent);
      },

      emitGestureEvent(event) {
        const currentState = this.getTouchState(event);
        const previousState = this.internalState.previousState;

        const gestureContinues = previousState && currentState && currentState.touchCount == previousState.touchCount;
        const gestureEnded = previousState && !gestureContinues;
        const gestureStarted = currentState && !gestureContinues;

        if (gestureEnded) {
          const eventName = this.getEventPrefix(previousState.touchCount) + 'end';
          this.el.emit(eventName, previousState);
          this.internalState.previousState = null;
        }

        if (gestureStarted) {
          currentState.startTime = performance.now();
          currentState.startPosition = currentState.position;
          currentState.startSpread = currentState.spread;
          const eventName = this.getEventPrefix(currentState.touchCount) + 'start';
          this.el.emit(eventName, currentState);
          this.internalState.previousState = currentState;
        }

        if (gestureContinues) {
          const eventDetail = {
            positionChange: {
              x: currentState.position.x - previousState.position.x,
              y: currentState.position.y - previousState.position.y
            }
          };

          if (currentState.spread) {
            eventDetail.spreadChange = currentState.spread - previousState.spread;
          }

          eventDetail.startPosition = previousState.startPosition;
          eventDetail.position = currentState.position;
          eventDetail.startSpread = previousState.startSpread;
          eventDetail.spread = currentState.spread;

          const eventName = this.getEventPrefix(currentState.touchCount) + 'move';
          this.el.emit(eventName, eventDetail);
          this.internalState.previousState = currentState;
        }
      },

      getTouchState: function (event) {
        if (event.touches.length === 0) return null;

        const touchList = [];
        for (let i = 0; i < event.touches.length; i++) {
          touchList.push(event.touches[i]);
        }

        const touchState = { touchCount: touchList.length };

        const centerX = touchList.reduce((sum, t) => sum + t.clientX, 0) / touchList.length;
        const centerY = touchList.reduce((sum, t) => sum + t.clientY, 0) / touchList.length;
        touchState.position = { x: centerX, y: centerY };

        if (touchList.length >= 2) {
          const dx = touchList[0].clientX - touchList[1].clientX;
          const dy = touchList[0].clientY - touchList[1].clientY;
          touchState.spread = Math.sqrt(dx * dx + dy * dy);
        }

        return touchState;
      },

      getEventPrefix(touchCount) {
        const names = ['one', 'two', 'three', 'many'];
        return names[Math.min(touchCount, 4) - 1] + 'finger';
      }
    });

    // Gesture handler component
    AFRAME.registerComponent('gesture-handler', {
      schema: {
        enabled: { default: true },
        rotationFactor: { default: 5 },
        minScale: { default: 0.3 },
        maxScale: { default: 8 }
      },

      init: function () {
        this.handleScale = this.handleScale.bind(this);
        this.handleRotation = this.handleRotation.bind(this);

        this.initialScale = this.el.object3D.scale.clone();
        this.scaleFactor = 1;

        this.el.sceneEl.addEventListener('onefingermove', this.handleRotation);
        this.el.sceneEl.addEventListener('twofingermove', this.handleScale);
      },

      remove: function () {
        this.el.sceneEl.removeEventListener('onefingermove', this.handleRotation);
        this.el.sceneEl.removeEventListener('twofingermove', this.handleScale);
      },

      handleRotation: function (event) {
        if (!this.data.enabled || !this.el.getAttribute('visible')) return;
        
        this.el.object3D.rotation.y += event.detail.positionChange.x / window.innerWidth * Math.PI * this.data.rotationFactor;
      },

      handleScale: function (event) {
        if (!this.data.enabled || !this.el.getAttribute('visible')) return;

        if (event.detail.spreadChange) {
          const scaleFactor = 1 + (event.detail.spreadChange / event.detail.startSpread);
          this.scaleFactor = Math.min(Math.max(this.scaleFactor * scaleFactor, this.data.minScale), this.data.maxScale);

          this.el.object3D.scale.set(
            this.initialScale.x * this.scaleFactor,
            this.initialScale.y * this.scaleFactor,
            this.initialScale.z * this.scaleFactor
          );
        }
      }
    });

    // UI Elements
    const startScreen = document.getElementById('start-screen');
    const startBtn = document.getElementById('start-ar-btn');
    const errorMsg = document.getElementById('error-msg');
    const loadingOverlay = document.getElementById('loading-overlay');
    const statusBar = document.getElementById('status-bar');
    const statusText = document.getElementById('status-text');
    const placeButton = document.getElementById('place-button');
    const controlsHint = document.getElementById('controls-hint');
    const crosshair = document.getElementById('crosshair');
    const sceneEl = document.getElementById('scene');
    const furniture = document.getElementById('furniture');

    let isPlaced = false;
    let arReady = false;

    // Start AR Experience
    startBtn.addEventListener('click', async () => {
      try {
        startBtn.disabled = true;
        startBtn.textContent = 'STARTING...';
        errorMsg.classList.remove('visible');

        console.log('Starting AR experience...');

        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Camera access not supported in this browser. Please use Chrome, Safari, or Firefox.');
        }

        // Show loading overlay
        loadingOverlay.classList.add('visible');

        // Request camera permission
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });

        console.log('Camera access granted');
        
        // Stop the test stream (AR.js will handle the actual stream)
        stream.getTracks().forEach(track => track.stop());

        // Small delay to ensure everything is ready
        await new Promise(resolve => setTimeout(resolve, 500));

        // Hide start screen and show AR
        startScreen.classList.add('hidden');
        loadingOverlay.classList.remove('visible');
        
        // Show UI elements
        statusBar.classList.add('visible');
        crosshair.classList.add('visible');
        placeButton.classList.add('visible');
        
        arReady = true;
        
        console.log('AR Ready!');

        // Auto-hide status bar after 5 seconds
        setTimeout(() => {
          statusBar.style.opacity = '0';
          setTimeout(() => {
            statusBar.classList.remove('visible');
            statusBar.style.opacity = '1';
          }, 300);
        }, 5000);

      } catch (error) {
        console.error('AR initialization error:', error);
        
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ START AR';
        loadingOverlay.classList.remove('visible');
        
        let errorMessage = '';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMessage = 'üì∑ Camera access denied. Please allow camera permissions in your browser settings and try again.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
          errorMessage = 'üì∑ No camera found on this device. Please make sure your device has a working camera.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
          errorMessage = 'üì∑ Camera is being used by another app. Please close other apps using the camera and try again.';
        } else if (error.name === 'OverconstrainedError') {
          errorMessage = 'üì∑ Camera does not meet requirements. Try using a different device.';
        } else if (error.name === 'SecurityError') {
          errorMessage = 'üîí Security error. Make sure you\'re using HTTPS or localhost.';
        } else {
          errorMessage = `‚ùå Error: ${error.message || 'Could not start AR. Please check your camera permissions and try again.'}`;
        }
        
        errorMsg.textContent = errorMessage;
        errorMsg.classList.add('visible');
      }
    });

    // Place furniture button
    placeButton.addEventListener('click', () => {
      if (!arReady) {
        console.log('AR not ready yet');
        return;
      }

      const camera = document.querySelector('#camera');
      if (!camera) {
        console.error('Camera not found');
        return;
      }

      // Get camera position and rotation
      const cameraPos = camera.object3D.position;
      const cameraRot = camera.object3D.rotation;

      // Calculate position in front of camera
      const distance = 1.5;
      const radY = cameraRot.y;
      
      const newPos = {
        x: cameraPos.x - Math.sin(radY) * distance,
        y: cameraPos.y - 0.5, // Slightly below camera
        z: cameraPos.z - Math.cos(radY) * distance
      };

      if (!isPlaced) {
        // First time placement
        furniture.setAttribute('position', `${newPos.x} ${newPos.y} ${newPos.z}`);
        furniture.setAttribute('visible', 'true');
        
        // Animate appearance
        furniture.setAttribute('animation__appear', {
          property: 'scale',
          from: '0 0 0',
          to: '1 1 1',
          dur: 600,
          easing: 'easeOutElastic'
        });
        
        isPlaced = true;
        placeButton.textContent = '‚úÖ PLACED!';
        placeButton.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        
        controlsHint.classList.add('visible');
        crosshair.classList.remove('visible');
        
        console.log('Furniture placed at:', newPos);
        
        // Reset button after animation
        setTimeout(() => {
          placeButton.textContent = 'üìç MOVE CHAIR';
          placeButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          controlsHint.classList.remove('visible');
        }, 3000);
        
      } else {
        // Move existing furniture
        furniture.setAttribute('position', `${newPos.x} ${newPos.y} ${newPos.z}`);
        
        // Bounce animation
        furniture.setAttribute('animation__move', {
          property: 'scale',
          from: '1 1 1',
          to: '1.15 1.15 1.15',
          dur: 200,
          dir: 'alternate',
          loop: 1
        });
        
        placeButton.textContent = '‚úÖ MOVED!';
        
        console.log('Furniture moved to:', newPos);
        
        setTimeout(() => {
          placeButton.textContent = 'üìç MOVE CHAIR';
        }, 1500);
      }
    });

    // Log when scene is ready
    sceneEl.addEventListener('loaded', () => {
      console.log('A-Frame scene loaded');
    });

    // Log AR.js events
    sceneEl.addEventListener('arjs-video-loaded', () => {
      console.log('AR.js camera loaded');
    });

    console.log('AR App initialized. Click "Start AR" to begin.');
  </script>
</body>
</html>